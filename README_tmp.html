<!DOCTYPE html>
<html>

<head>
    <title>README.md</title>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    
<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

html,footer,header{
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Custom MD PDF CSS
 */
html,footer,header{
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";

 }
body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>
<link rel="stylesheet" href="file:///var/www/html/moodletest/R%3A%5C2.Travail%5C1.Enseignement%5CCours%5C_1.Outils%5C2.Developpement%5C1.SCSS%5Cmain.css" type="text/css"><link rel="stylesheet" href="file:///var/www/html/moodletest/D%3A%5Crdaros%5CCours%5C_1.Outils%5C2.Developpement%5C1.SCSS%5Cmain.css" type="text/css">
</head>

<body>
    <h1 id="registration-plugin-for-moodle">Registration plugin for moodle</h1>
<p>This plugin allows us to register users into moodle. It is a test case so it should not be used on production level until properly tested.</p>
<p>This module creates a registration form, the user submits the form and he receives an email with a temporary password and a link which will allow him to change that password.</p>
<p>Once the password has been changed he will be allowed to use the moodle platform.</p>
<p>The content of this repository should be installed inside the the /local/registration folder of a moodle site.</p>
<h2 id="notes">NOTES</h2>
<p>This plugin consists on:</p>
<ul>
<li>version.php: plugin definition file</li>
<li>register.php: registerForm rendering controller file</li>
<li>user_created.php: controller file redirected once user has been registered.</li>
<li>new_password.php: controller file rendering the new password form. This file is pointed at in the email that gets sent to the user.</li>
<li>password_renewed.php: controller file redirected once user has renewed the password.</li>
<li>cancelled.php: controller we get redirected to on cancellation of the form submission and/or failure to create a user.</li>
<li>classes/form/registrationForm.php : Form and validation code for registration form</li>
<li>classes/form/newPasswordForm.php: Form and validation code for new Password form.</li>
<li>classes/manager.php: &quot;services&quot; or &quot;helper&quot; class to process the submitted data (create user, send email ...)</li>
<li>lang/en/local_registration.php: localisation file for english language strings.</li>
<li>templates/cancelled.mustache: template for cancelled.php</li>
<li>templates/password_renewed.mustache: Template for password_renewed.php file</li>
<li>templates/user_create.mustache: Template for user_created.php file.</li>
</ul>
<p>This plugin has been implemented for Moodle Version 4.2.1+ (Build: 20230721)<br>
A working site where it has been installed can be found at https://moodle.lehioa.katakrak.net</p>
<p>The application files can be accessed at<br>
https://moodle.lehioa.katakrak.net/local/registration/register.php<br>
https://moodle.lehioa.katakrak.net/local/registration/new_password.php (login protected)</p>
<h2 id="about-the-process">ABOUT THE PROCESS</h2>
<p>At time of the publication of this note some of the expected tasks have been accomplished but also some problems have been met.</p>
<ul>
<li>So far the plugin has worked for these tasks
<ul>
<li>Creation of a new user account with temporary password creation</li>
<li>Validation of fields</li>
<li>Rendering of the forms and redirections</li>
</ul>
</li>
<li>The problem arises with the login procedure. When submitting the username with email and the password the submitted fails to verify against the one stored in the database. In order to tackle this issue I have &quot;hacked&quot; lib/moodlelib.php and added some debugging tags that would provide data to a file called /errorlog/debug.log where I could check the results. I have been actively checking these results with AI tool (chatGPT) but reached unconclusive results. I do realise that the task may have an &quot;easy solution&quot; but yet tried to go to the bottom of the issue in order to understand what is happening.</li>
</ul>
<p>I have &quot;hacked&quot; the &quot;validate_internal_user_password&quot; function of lib/moodlelib.php in order to bring light to this issue:</p>
<pre class="hljs"><code><div>function validate_internal_user_password($user, $password) {
    global $CFG;
    file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;Validating password for: {$user-&gt;username}, password: {$password}\n&quot;, FILE_APPEND);
    if ($user-&gt;password === AUTH_PASSWORD_NOT_CACHED) {
        // Internal password is not used at all, it can not validate.
        return false;
    }

    // If hash isn't a legacy (md5) hash, validate using the library function.
    if (!password_is_legacy_hash($user-&gt;password)) {
        file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;Password is not legacy hash: {$user-&gt;password}\n&quot;, FILE_APPEND);
        $result = password_verify($password, $user-&gt;password);
        file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;Result of function password verify: {$result}\n&quot;, FILE_APPEND);
        if (!$result) {
            file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;Password did not match the hash for: {$user-&gt;username}\n&quot;, FILE_APPEND);
        }

        return $result;
        
    }

    // Otherwise we need to check for a legacy (md5) hash instead. If the hash
    // is valid we can then update it to the new algorithm.

    $sitesalt = isset($CFG-&gt;passwordsaltmain) ? $CFG-&gt;passwordsaltmain : '';
    $validated = false;
    file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;Checking for legacy Hash\n&quot;, FILE_APPEND);
    
    file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;password:&quot; . $password.&quot;\n&quot;, FILE_APPEND);
    file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;User-&gt;password:&quot;. $user-&gt;password . &quot;\n&quot;, FILE_APPEND);
    file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;md5(password.sitesalt):&quot; . md5($password.$sitesalt).&quot;\n&quot;, FILE_APPEND);
    file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;md5(password):&quot; . md5($password).&quot;\n&quot;, FILE_APPEND);
    file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;md5(addslashes(password.sitesalt)):&quot; . md5(addslashes($password).$sitesalt).&quot;\n&quot;, FILE_APPEND);
    file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', &quot;md5(addslashes(password):&quot; . md5(addslashes($password)).&quot;\n&quot;, FILE_APPEND);
    if ($user-&gt;password === md5($password.$sitesalt)
            or $user-&gt;password === md5($password)
            or $user-&gt;password === md5(addslashes($password).$sitesalt)
            or $user-&gt;password === md5(addslashes($password))) {
        // Note: we are intentionally using the addslashes() here because we
        //       need to accept old password hashes of passwords with magic quotes.
        file_put_contents($CFG-&gt;dirroot . '/errorlog/debug.log', 'Inside multiple if statement', FILE_APPEND);
        $validated = true;

    } else {
        for ($i=1; $i&lt;=20; $i++) { // 20 alternative salts should be enough, right?
            $alt = 'passwordsaltalt'.$i;
            if (!empty($CFG-&gt;$alt)) {
                if ($user-&gt;password === md5($password.$CFG-&gt;$alt) or $user-&gt;password === md5(addslashes($password).$CFG-&gt;$alt)) {
                    $validated = true;
                    break;
                }
            }
        }
    }

    if ($validated) {
        // If the password matches the existing md5 hash, update to the
        // current hash algorithm while we have access to the user's password.
        update_internal_user_password($user, $password);
    }

    return $validated;
}
</div></code></pre>
<p>It's on this line &quot;if (!password_is_legacy_hash($user-&gt;password)) &quot; that the system would return false thus preventing the login. Nonetheless the password creating functions that are used are internal functions of moodle as can be seen in local/registration/manage.php</p>
<pre class="hljs"><code><div>        $user-&gt;temporaryPassword = generate_password(10);
        $user-&gt;password = hash_internal_user_password($user-&gt;temporaryPassword);
</div></code></pre>
<p>At the time of submitting this code for analysis this issue remains unsolved expecting to be solve in the forthcoming time.</p>
<p>Chat with chatgpt for this part of the problem</p>
<p>https://chat.openai.com/share/0b05f35f-435a-492c-9f1a-e19dbef9170f</p>

</body>

</html>